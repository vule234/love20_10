<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Planet - Không gian tình yêu 3D</title>
    <meta name="description" content="Trải nghiệm không gian 3D nghệ thuật với trái tim phát sáng, vòng ảnh quay và hiệu ứng particle">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>💖</text></svg>">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            background: #000;
            color: #fff;
        }
        
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .ui-overlay > * {
            pointer-events: auto;
        }
        
        header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            color: #FF66CC;
            text-shadow: 0 0 10px rgba(255, 102, 204, 0.5);
        }
        
        .logo i {
            font-size: 30px;
        }
        
        .control-buttons {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px 25px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
        }
        
        .control-btn:hover {
            background: rgba(255, 102, 204, 0.3);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 102, 204, 0.5);
        }
        
        .control-btn.active {
            background: rgba(255, 102, 204, 0.5);
            box-shadow: 0 0 20px rgba(255, 102, 204, 0.7);
        }
        
        footer {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: rgba(20, 20, 40, 0.9);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 102, 204, 0.3);
            box-shadow: 0 0 30px rgba(255, 102, 204, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            color: #FF66CC;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            color: #FF66CC;
            transform: rotate(90deg);
        }
        
        .message-content {
            font-size: 18px;
            line-height: 1.6;
            color: #fff;
            text-align: left;
            padding: 20px;
            font-family: 'Dancing Script', cursive;
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 1s ease;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader {
            width: 80px;
            height: 80px;
            border: 5px solid rgba(255, 102, 204, 0.3);
            border-top: 5px solid #FF66CC;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: #FF66CC;
        }
        
        .loading-progress {
            margin-top: 15px;
            width: 80%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .loading-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #FF66CC, #FF99CC);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .loading-status {
            margin-top: 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .instructions {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            max-width: 250px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #FF66CC;
        }
        
        .instructions p {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .instructions.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .text-3d-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 5;
            text-align: center;
            opacity: 0;
            transition: opacity 1s ease;
            max-width: 80%;
        }
        
        .text-3d-container.visible {
            opacity: 1;
        }
        
        .text-3d {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(45deg, #FF66CC, #FF99CC, #FFCCFF);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 20px rgba(255, 102, 204, 0.5);
            animation: pulse 2s infinite alternate;
            font-family: 'Dancing Script', cursive;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        
        .letter-3d-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: auto;
            z-index: 5;
            opacity: 0;
            transition: opacity 1s ease;
            max-width: 80%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 102, 204, 0.3);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(255, 102, 204, 0.2);
        }
        
        .letter-3d-container.visible {
            opacity: 1;
        }
        
        .letter-3d-content {
            font-size: 1.5rem;
            line-height: 1.8;
            color: #fff;
            font-family: 'Dancing Script', cursive;
            text-align: left;
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .letter-3d-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .letter-3d-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .letter-3d-content::-webkit-scrollbar-thumb {
            background: rgba(255, 102, 204, 0.5);
            border-radius: 10px;
        }
        
        .letter-3d-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 102, 204, 0.7);
        }
        
        .zoom-info {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 50;
            text-align: center;
        }
        
        .zoom-info.visible {
            opacity: 1;
        }
        
        .pass-through-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 102, 204, 0.3) 0%, rgba(255, 102, 204, 0) 70%);
            opacity: 0;
            pointer-events: none;
            z-index: 30;
            transition: opacity 0.3s ease;
        }
        
        .pass-through-effect.active {
            opacity: 1;
        }
        
        .spiral-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 102, 204, 0.4) 0%, rgba(255, 102, 204, 0) 70%);
            opacity: 0;
            pointer-events: none;
            z-index: 30;
            transition: opacity 0.3s ease;
        }
        
        .spiral-effect.active {
            opacity: 1;
        }
        
        .audio-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .audio-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .audio-btn:hover {
            background: rgba(255, 102, 204, 0.3);
            transform: scale(1.1);
        }
        
        .audio-btn.active {
            background: rgba(255, 102, 204, 0.5);
        }
        
        .image-path-input {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            z-index: 50;
            width: 80%;
            max-width: 500px;
        }
        
        .image-path-input.active {
            display: block;
        }
        
        .image-path-input h3 {
            color: #FF66CC;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .path-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .path-input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            outline: none;
        }
        
        .path-input:focus {
            border-color: rgba(255, 102, 204, 0.5);
            background: rgba(255, 102, 204, 0.1);
        }
        
        .add-path-btn {
            padding: 8px 15px;
            background: rgba(255, 102, 204, 0.3);
            border: 1px solid rgba(255, 102, 204, 0.5);
            border-radius: 8px;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .add-path-btn:hover {
            background: rgba(255, 102, 204, 0.5);
        }
        
        .path-list {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        
        .path-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .path-item-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 12px;
        }
        
        .remove-path-btn {
            background: none;
            border: none;
            color: #FF66CC;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .remove-path-btn:hover {
            color: #ff3366;
        }
        
        .path-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .path-action-btn {
            flex: 1;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .path-action-btn:hover {
            background: rgba(255, 102, 204, 0.3);
        }
        
        .path-action-btn.primary {
            background: rgba(255, 102, 204, 0.3);
            border: 1px solid rgba(255, 102, 204, 0.5);
        }
        
        .path-action-btn.primary:hover {
            background: rgba(255, 102, 204, 0.5);
        }
        
        .settings-btn {
            position: absolute;
            top: 20px;
            right: 70px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .settings-btn:hover {
            background: rgba(255, 102, 204, 0.3);
            transform: scale(1.1);
        }
        
        .music-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .music-indicator.visible {
            opacity: 1;
        }
        
        .music-icon {
            animation: pulse 1.5s infinite alternate;
        }
        
        @media (max-width: 768px) {
            .control-buttons {
                bottom: 20px;
                padding: 10px 15px;
                gap: 15px;
            }
            
            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .instructions {
                display: none;
            }
            
            .text-3d {
                font-size: 2rem;
            }
            
            .letter-3d-content {
                font-size: 1.2rem;
            }
            
            .audio-controls {
                top: 70px;
                right: 10px;
            }
            
            .settings-btn {
                top: 70px;
                right: 50px;
            }
            
            .image-path-input {
                width: 90%;
                bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">Đang tải không gian tình yêu...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
        <div class="loading-status" id="loadingStatus">Khởi tạo cảnh 3D...</div>
    </div>
    
    <!-- Canvas Container -->
    <div id="canvas-container"></div>
    
    <!-- Pass Through Effect -->
    <div class="pass-through-effect" id="passThroughEffect"></div>
    
    <!-- Spiral Effect -->
    <div class="spiral-effect" id="spiralEffect"></div>
    
    <!-- 3D Text Container -->
    <div class="text-3d-container" id="text3dContainer">
        <div class="text-3d">Tình yêu là vũ trụ</div>
    </div>
    
    <!-- 3D Letter Container -->
    <!-- 3D Letter Container -->
<div class="letter-3d-container" id="letter3dContainer">
    <div class="letter-3d-content" id="letter3dContent">
        <p>Anh muốn nói với em rằng...</p>
        <p style="margin-top: 15px;">Sẽ có những lúc hai ta chưa đủ hiểu nhau, giận hờn hoặc cãi nhau. Có lẽ sẽ chẳng còn cảm giác mới mẻ. Có lẽ sẽ không có chủ đề chung, có lẽ chúng ta cũng sẽ chiến tranh lạnh.</p>
        <p style="margin-top: 15px;">Nhưng em ơi, để đến được ngày hôm nay cũng không phải là điều dễ dàng...</p>
        <p style="margin-top: 15px;">Anh mong cho hai ta vẫn mãi là của nhau, cho dù ngày mai ra sao, chặng đường tương lai vất vả thế nào đi nữa, trái tim này vẫn chẳng thể nào ngừng yêu em.</p>
        <p style="margin-top: 15px;">Mãi yêu Tố Linh.</p>
        <p style="margin-top: 15px;">20/10 hạnh phúc nhé, yêu em!!</p>
    </div>
</div>
    
    <!-- Zoom Info -->
    <div class="zoom-info" id="zoomInfo">
        <p>Nhấn đúp để bay xoắn vào trái tim</p>
        <p>Nhấn đúp lần nữa để bay ra xuyên qua ảnh</p>
    </div>
    
    <!-- Image Path Input -->
    <div class="image-path-input" id="imagePathInput">
        <h3>Quản lý ảnh</h3>
        <div class="path-input-group">
            <input type="text" class="path-input" id="pathInput" placeholder="Nhập đường dẫn ảnh...">
            <button class="add-path-btn" id="addPathBtn">Thêm</button>
        </div>
        <div class="path-list" id="pathList"></div>
        <div class="path-actions">
            <button class="path-action-btn" id="clearAllBtn">Xóa tất cả</button>
            <button class="path-action-btn primary" id="applyBtn">Áp dụng</button>
        </div>
    </div>
    
    <!-- Music Indicator -->
    <div class="music-indicator" id="musicIndicator">
        <i class="fas fa-music music-icon"></i>
        <span>Đang phát nhạc nền</span>
    </div>
    
    <!-- UI Overlay -->
    <div class="ui-overlay">
        <header>
            <div class="logo">
                <i class="fas fa-heart"></i>
                <span>Tố Linh Planet</span>
            </div>
            
            <div class="audio-controls">
                <div class="audio-btn" id="musicBtn" title="Tắt/Bật nhạc">
                    <i class="fas fa-music"></i>
                </div>
            </div>
            
            <div class="settings-btn" id="settingsBtn" title="Cài đặt ảnh">
                <i class="fas fa-cog"></i>
            </div>
        </header>
        
        <div class="control-buttons">
            <div class="control-btn" id="giftBtn" title="Hiện ảnh">
                <i class="fas fa-gift"></i>
            </div>
            <div class="control-btn" id="letterBtn" title="Lời nhắn 3D">
                <i class="fas fa-envelope"></i>
            </div>
        </div>
    </div>
    
    <!-- Message Modal -->
    <div class="modal" id="messageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Lời nhắn từ trái tim</h2>
                <button class="close-btn" id="closeMessageBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="message-content">
                <p>Gửi em, người con gái anh yêu,</p>
                <p style="margin-top: 15px;">Từ ngày gặp em, thế giới của anh đã bừng sáng một cách kỳ diệu. Nụ cười của em như nắng mai ban mai, sưởi ấm tâm hồn anh. Ánh mắt em như vì sao đêm nay, dẫn lối anh trong những giấc mơ.</p>
                <p style="margin-top: 15px;">Em có biết không? Mỗi ngày trôi qua, tình yêu anh dành cho em lại lớn thêm một chút. Anh yêu cách em nhíu mày khi suy nghĩ, yêu cách em cười toe toét khi vui vẻ, yêu cả những lúc em giận hờn đáng yêu.</p>
                <p style="margin-top: 15px;">Anh muốn cùng em đi qua mọi nẻo đường, cùng em chứng kiến những bình minh và hoàng hôn, cùng em viết nên câu chuyện tình yêu đẹp nhất. Anh hứa sẽ luôn là bờ vai vững chãi cho em tựa vào, là người lắng nghe mọi tâm sự của em.</p>
                <p style="margin-top: 15px;">Trong vũ trụ bao la, có những vì sao lấp lánh, nhưng không ngôi sao nào sáng bằng tình yêu của anh dành cho em. Tình yêu của chúng ta giống như những hành tinh trong không gian, mỗi hành tinh có một vẻ đẹp riêng, nhưng khi kết hợp lại tạo nên một thiên hà tuyệt vời.</p>
                <p style="margin-top: 15px;">Dù chúng ta có ở xa nhau, trái tim anh luôn hướng về em, giống như mặt trăng luôn hướng về Trái Đất. Mong rằng một ngày không xa, chúng ta sẽ cùng nhau khám phá những hành tinh của tình yêu.</p>
                <p style="margin-top: 15px;">Em có đồng ý làm người thương của anh cả đời không?</p>
                <p style="margin-top: 15px;">Yêu em thật nhiều,</p>
                <p style="margin-top: 5px;">Người luôn nghĩ về em</p>
            </div>
        </div>
    </div>
    
    <!-- Audio Element -->
    <audio id="bgMusic" loop>
        <source src="music/music.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <script>
        // Global variables
        let scene, camera, renderer, controls;
        let heart, imageRing, particles, shootingStars = [];
        let isMusicPlaying = false;
        let isImageRingVisible = false;
        let isTextVisible = false;
        let isLetterVisible = false;
        let particleColor = 0xFF66CC;
        let rotationSpeed = 0.5;
        let imageCount = 300;
        let shootingStarFrequency = 0.5;
        let raycaster, mouse;
        let hoveredImage = null;
        let heartGlow;
        let isZoomedIn = false;
        let zoomAnimation = null;
        let lastClickTime = 0;
        let clickDelay = 300; // milliseconds
        let originalFov;
        
        // Image URLs
        let uniqueImageUrls = [
            'Picture/IMG_0331.jpg',
            'Picture/IMG_0331-copy-0.jpg',
            'Picture/IMG_1001.jpg',
            'Picture/IMG_1001-copy-0.jpg',
            'Picture/IMG_1013.jpg',
            'Picture/IMG_1016.jpg',
            'Picture/IMG_1374.jpg',
            'Picture/IMG_1376.jpg',
            'Picture/IMG_1393.jpg',
            'Picture/IMG_0083.jpg',
            'Picture/IMG_0262.jpg',
            'Picture/IMG_0309.jpg',
            'Picture/IMG_0114.jpg',
            'Picture/IMG_0299.jpg',
            'Picture/IMG_9292.jpg',
            'Picture/IMG_9647.jpg',
            'Picture/IMG_0079.jpg',
            'Picture/IMG_1247.jpg',
            'Picture/IMG_1250.jpg',
            'Picture/IMG_1251.jpg',
            'Picture/IMG_7446.jpg',
            'Picture/IMG_9628.jpg',
            'Picture/IMG_9656.jpg',
            'Picture/IMG_6996.jpg',
            'Picture/IMG_7008.jpg',
            'Picture/IMG_7440.jpg',
            'Picture/IMG_7444.jpg',
            'Picture/IMG_7009.jpg',
            'Picture/IMG_7111.jpg',
            'Picture/IMG_7128.jpg',
            'Picture/IMG_7133.jpg',
            'Picture/IMG_6774.jpg',
            'Picture/IMG_7150.jpg',
            'Picture/IMG_7438.jpg',
            'Picture/IMG_5888.jpg',
            'Picture/IMG_5903.jpg',
            'Picture/IMG_6621.jpg',
            'Picture/IMG_6622.jpg',
            'Picture/IMG_6623.jpg',
            'Picture/IMG_6625.jpg',
            'Picture/IMG_5759.jpg',
            'Picture/IMG_6722.jpg',
            'Picture/IMG_6772.jpg',
            'Picture/IMG_5884.jpg',
            'Picture/IMG_5885.jpg',
            'Picture/IMG_4780.jpg',
            'Picture/IMG_4789.jpg',
            'Picture/IMG_4790.jpg',
            'Picture/IMG_5757.jpg',
            'Picture/IMG_5758.jpg',
        ];
        
        let tempImageUrls = [...uniqueImageUrls];
        
        // Loading manager
        let loadedImages = 0;
        let totalImages = uniqueImageUrls.length;
        let loadingManager = {
            updateProgress: function(loaded, total, status) {
                const progressBar = document.getElementById('loadingProgressBar');
                const statusText = document.getElementById('loadingStatus');
                const progress = (loaded / total) * 100;
                progressBar.style.width = progress + '%';
                statusText.textContent = status + ' (' + loaded + '/' + total + ')';
            }
        };
        
        // Preload images
        function preloadImages() {
            return new Promise((resolve, reject) => {
                const imageTextures = [];
                let loadedCount = 0;
                
                loadingManager.updateProgress(0, totalImages, 'Đang tải ảnh...');
                
                const textureLoader = new THREE.TextureLoader();
                
                uniqueImageUrls.forEach((url, index) => {
                    textureLoader.load(
                        url,
                        (texture) => {
                            imageTextures[index] = texture;
                            loadedCount++;
                            loadingManager.updateProgress(loadedCount, totalImages, 'Đang tải ảnh...');
                            
                            if (loadedCount === totalImages) {
                                resolve(imageTextures);
                                loadingManager.updateProgress(totalImages, totalImages, 'Hoàn tất tất cả!');
                                setTimeout(() => {
                                    document.getElementById('loadingScreen').classList.add('hidden');
                                }, 1000);
                            }
                        },
                        undefined,
                        (xhr) => {
                            console.error('Không thể tải ảnh:', url);
                            loadedCount++;
                            loadingManager.updateProgress(loadedCount, totalImages, 'Lỗi tải ảnh: ' + url);
                            
                            const canvas = document.createElement('canvas');
                            canvas.width = 256;
                            canvas.height = 256;
                            const context = canvas.getContext('2d');
                            context.fillStyle = '#FF3366';
                            context.fillRect(0, 0, 256, 256);
                            context.fillStyle = '#FFFFFF';
                            context.font = '20px Arial';
                            context.textAlign = 'center';
                            context.fillText('Lỗi', 128, 128);
                            
                            const errorTexture = new THREE.CanvasTexture(canvas);
                            imageTextures[index] = errorTexture;
                            
                            if (loadedCount === totalImages) {
                                resolve(imageTextures);
                                setTimeout(() => {
                                    document.getElementById('loadingScreen').classList.add('hidden');
                                }, 1000);
                            }
                        }
                    );
                });
            });
        }
        
        // Initialize the 3D scene
        async function init() {
            try {
                const imageTextures = await preloadImages();
                
                scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x000000, 0.0008);
                
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 10, 50);
                originalFov = camera.fov;
                
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.getElementById('canvas-container').appendChild(renderer.domElement);
                
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.minDistance = 5;
                controls.maxDistance = 80;
                controls.enableZoom = true;
                controls.zoomSpeed = 1.0;
                controls.autoRotate = true;
                controls.autoRotateSpeed = 0.5;
                
                raycaster = new THREE.Raycaster();
                mouse = new THREE.Vector2();
                
                createHeart();
                createImageRing(imageTextures);
                createParticles();
                createShootingStars();
                createLights();
                
                addEventListeners();
                
                // Auto-play music
                const music = document.getElementById('bgMusic');
                const musicIndicator = document.getElementById('musicIndicator');
                music.play().then(() => {
                    isMusicPlaying = true;
                    document.getElementById('musicBtn').classList.add('active');
                    musicIndicator.classList.add('visible');
                    setTimeout(() => {
                        musicIndicator.classList.remove('visible');
                    }, 3000);
                }).catch(error => {
                    console.error("Không thể phát nhạc tự động:", error);
                });
                
                // Show zoom info
                setTimeout(() => {
                    document.getElementById('zoomInfo').classList.add('visible');
                    setTimeout(() => {
                        document.getElementById('zoomInfo').classList.remove('visible');
                    }, 5000);
                }, 3000);
                
                // Hide instructions after 10 seconds
                setTimeout(() => {
                    document.getElementById('instructions').classList.add('hidden');
                }, 10000);
                
                animate();
            } catch (error) {
                console.error('Lỗi khởi tạo cảnh 3D:', error);
                document.getElementById('loadingStatus').textContent = 'Lỗi khởi tạo cảnh 3D. Vui lòng tải lại trang.';
            }
        }
        
        // Create 3D heart
        function createHeart() {
            const heartShape = new THREE.Shape();
            const points = [];
            const segments = 100;
            
            for (let i = 0; i <= segments; i++) {
                const t = (i / segments) * Math.PI * 2;
                const x = 16 * Math.pow(Math.sin(t), 3);
                const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                points.push(new THREE.Vector2(x * 0.05, y * 0.05));
            }
            
            heartShape.setFromPoints(points);
            
            const extrudeSettings = {
                depth: 0.8,
                bevelEnabled: true,
                bevelSegments: 3,
                steps: 3,
                bevelSize: 0.15,
                bevelThickness: 0.15
            };
            
            const geometry = new THREE.ExtrudeGeometry(heartShape, extrudeSettings);
            const material = new THREE.MeshPhongMaterial({
                color: 0xFF3366,
                emissive: 0xFF3366,
                emissiveIntensity: 0.3,
                shininess: 100,
                specular: 0xffffff
            });
            
            heart = new THREE.Mesh(geometry, material);
            heart.position.set(0, 0, 0);
            heart.castShadow = true;
            heart.receiveShadow = true;
            
            heart.geometry.computeBoundingBox();
            const center = new THREE.Vector3();
            heart.geometry.boundingBox.getCenter(center);
            heart.geometry.translate(-center.x, -center.y, -center.z);
            
            heart.scale.set(2.5, 2.5, 2.5);
            scene.add(heart);
            
            const glowGeometry = new THREE.SphereGeometry(3.5, 32, 32);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: 0xFF66CC,
                transparent: true,
                opacity: 0.15
            });
            
            heartGlow = new THREE.Mesh(glowGeometry, glowMaterial);
            heart.add(heartGlow);
            
            gsap.to(heartGlow.material, {
                duration: 2,
                opacity: 0.35,
                repeat: -1,
                yoyo: true,
                ease: "power1.inOut"
            });
            
            gsap.to(heart.rotation, {
                duration: 4,
                z: 0.05,
                repeat: -1,
                yoyo: true,
                ease: "sine.inOut"
            });
        }
        
        // Create image ring with preloaded textures
        function createImageRing(imageTextures) {
            if (imageRing) {
                scene.remove(imageRing);
            }
            
            imageRing = new THREE.Group();
            
            const ringCount = 8;
            const imagesPerRing = Math.floor(imageCount / ringCount);
            
            // Use images in order, repeating if necessary
            let imageIndex = 0;
            
            for (let ring = 0; ring < ringCount; ring++) {
                const ringHeight = (ring - 3.5) * 0.6;
                const ringRadius = 8 + ring * 3.5;
                
                for (let i = 0; i < imagesPerRing; i++) {
                    const geometry = new THREE.PlaneGeometry(1, 1);
                    
                    // Use image in sequence, loop back if exceeding array length
                    const textureIndex = imageIndex % imageTextures.length;
                    const material = new THREE.MeshBasicMaterial({
                        map: imageTextures[textureIndex],
                        transparent: true,
                        side: THREE.DoubleSide
                    });
                    
                    const image = new THREE.Mesh(geometry, material);
                    
                    const angle = (i / imagesPerRing) * Math.PI * 2;
                    const radiusVariation = ringRadius + (Math.random() - 0.5) * 4;
                    const heightVariation = ringHeight + (Math.random() - 0.5) * 1.5;
                    const angleVariation = angle + (Math.random() - 0.5) * 0.2;
                    
                    image.position.x = Math.cos(angleVariation) * radiusVariation;
                    image.position.y = heightVariation;
                    image.position.z = Math.sin(angleVariation) * radiusVariation;
                    
                    const lookAtY = heightVariation + (Math.random() - 0.5) * 0.5;
                    image.lookAt(0, lookAtY, 0);
                    
                    const scale = 0.4 + Math.random() * 0.4;
                    image.scale.set(scale, scale, scale);
                    
                    image.userData.originalScale = scale;
                    image.userData.index = textureIndex;
                    image.userData.angle = angleVariation;
                    image.userData.radius = radiusVariation;
                    
                    imageRing.add(image);
                    
                    imageIndex++;
                }
            }
            
            imageRing.visible = false;
            scene.add(imageRing);
        }
        
        // Create particle system
        function createParticles() {
            const particleCount = window.innerWidth < 768 ? 1500 : 5000;
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            
            for (let i = 0; i < particleCount; i++) {
                positions.push(
                    (Math.random() - 0.5) * 80,
                    (Math.random() - 0.5) * 50,
                    (Math.random() - 0.5) * 80
                );
                
                const colorChoice = Math.random();
                let color;
                
                if (colorChoice < 0.4) {
                    color = new THREE.Color(0xFF66CC);
                } else if (colorChoice < 0.7) {
                    color = new THREE.Color(0x9966FF);
                } else {
                    color = new THREE.Color(0xFFFFFF);
                }
                
                color.setHSL(
                    color.getHSL({h:0, s:0, l:0}).h,
                    0.7 + Math.random() * 0.3,
                    0.5 + Math.random() * 0.3
                );
                colors.push(color.r, color.g, color.b);
            }
            
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            const material = new THREE.PointsMaterial({
                size: 0.1,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });
            
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }
        
        // Create shooting stars
        function createShootingStars() {
            for (let i = 0; i < 5; i++) {
                createShootingStar();
            }
        }
        
        // Create a single shooting star
        function createShootingStar() {
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            
            const startPoint = new THREE.Vector3(
                (Math.random() - 0.5) * 60,
                (Math.random() - 0.5) * 60,
                (Math.random() - 0.5) * 60
            );
            
            const endPoint = new THREE.Vector3(
                startPoint.x + (Math.random() - 0.5) * 30,
                startPoint.y + (Math.random() - 0.5) * 30,
                startPoint.z + (Math.random() - 0.5) * 30
            );
            
            positions.push(startPoint.x, startPoint.y, startPoint.z);
            positions.push(endPoint.x, endPoint.y, endPoint.z);
            
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            
            const material = new THREE.LineBasicMaterial({
                color: 0xFFFFFF,
                transparent: true,
                opacity: 0
            });
            
            const shootingStar = new THREE.Line(geometry, material);
            scene.add(shootingStar);
            
            animateShootingStar(shootingStar);
            
            shootingStars.push(shootingStar);
        }
        
        // Animate a shooting star
        function animateShootingStar(shootingStar) {
            gsap.to(shootingStar.material, {
                duration: 0.5,
                opacity: 1,
                ease: "power1.inOut"
            });
            
            const positions = shootingStar.geometry.attributes.position.array;
            const startPoint = new THREE.Vector3(positions[0], positions[1], positions[2]);
            const endPoint = new THREE.Vector3(positions[3], positions[4], positions[5]);
            
            const direction = new THREE.Vector3().subVectors(endPoint, startPoint).normalize();
            const distance = startPoint.distanceTo(endPoint);
            
            gsap.to(shootingStar.position, {
                duration: 2,
                x: direction.x * distance,
                y: direction.y * distance,
                z: direction.z * distance,
                ease: "power1.inOut",
                onComplete: () => {
                    gsap.to(shootingStar.material, {
                        duration: 0.5,
                        opacity: 0,
                        ease: "power1.inOut",
                        onComplete: () => {
                            shootingStar.position.set(0, 0, 0);
                            
                            const newStartPoint = new THREE.Vector3(
                                (Math.random() - 0.5) * 60,
                                (Math.random() - 0.5) * 60,
                                (Math.random() - 0.5) * 60
                            );
                            
                            const newEndPoint = new THREE.Vector3(
                                newStartPoint.x + (Math.random() - 0.5) * 30,
                                newStartPoint.y + (Math.random() - 0.5) * 30,
                                newStartPoint.z + (Math.random() - 0.5) * 30
                            );
                            
                            positions[0] = newStartPoint.x;
                            positions[1] = newStartPoint.y;
                            positions[2] = newStartPoint.z;
                            positions[3] = newEndPoint.x;
                            positions[4] = newEndPoint.y;
                            positions[5] = newEndPoint.z;
                            
                            shootingStar.geometry.attributes.position.needsUpdate = true;
                            
                            const delay = 1000 + (1 - shootingStarFrequency) * 9000;
                            setTimeout(() => {
                                animateShootingStar(shootingStar);
                            }, delay);
                        }
                    });
                }
            });
        }
        
        // Create lights
        function createLights() {
            const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambientLight);
            
            const pointLight = new THREE.PointLight(0xffffff, 1, 100);
            pointLight.position.set(0, 0, 0);
            pointLight.castShadow = true;
            scene.add(pointLight);
            
            const pinkLight = new THREE.PointLight(0xFF66CC, 0.5, 20);
            pinkLight.position.set(0, 0, 0);
            scene.add(pinkLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(10, 10, 10);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
        }
        
        // Add event listeners
        function addEventListeners() {
            window.addEventListener('resize', onWindowResize);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('click', onMouseClick);
            window.addEventListener('touchstart', onTouchStart);
            
            document.getElementById('giftBtn').addEventListener('click', toggleImageRing);
            document.getElementById('letterBtn').addEventListener('click', toggleLetter);
            document.getElementById('musicBtn').addEventListener('click', toggleMusic);
            document.getElementById('settingsBtn').addEventListener('click', toggleSettings);
            document.getElementById('addPathBtn').addEventListener('click', addImagePath);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllPaths);
            document.getElementById('applyBtn').addEventListener('click', applyImagePaths);
            document.getElementById('closeMessageBtn').addEventListener('click', hideMessage);
        }
        
        // Toggle music
        function toggleMusic() {
            const music = document.getElementById('bgMusic');
            const musicBtn = document.getElementById('musicBtn');
            const musicIndicator = document.getElementById('musicIndicator');
            
            if (isMusicPlaying) {
                music.pause();
                musicBtn.classList.remove('active');
                musicIndicator.innerHTML = '<i class="fas fa-pause"></i><span>Nhạc đã tắt</span>';
                musicIndicator.classList.add('visible');
                setTimeout(() => {
                    musicIndicator.classList.remove('visible');
                    musicIndicator.innerHTML = '<i class="fas fa-music music-icon"></i><span>Đang phát nhạc nền</span>';
                }, 2000);
            } else {
                music.play().catch(e => console.error("Error playing music:", e));
                musicBtn.classList.add('active');
                musicIndicator.classList.add('visible');
                setTimeout(() => {
                    musicIndicator.classList.remove('visible');
                }, 3000);
            }
            
            isMusicPlaying = !isMusicPlaying;
        }
        
        // Window resize handler
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Mouse move handler
        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            
            if (imageRing && isImageRingVisible) {
                const intersects = raycaster.intersectObjects(imageRing.children);
                
                if (hoveredImage) {
                    hoveredImage.scale.set(
                        hoveredImage.userData.originalScale,
                        hoveredImage.userData.originalScale,
                        hoveredImage.userData.originalScale
                    );
                    hoveredImage = null;
                }
                
                if (intersects.length > 0) {
                    hoveredImage = intersects[0].object;
                    hoveredImage.scale.set(
                        hoveredImage.userData.originalScale * 1.2,
                        hoveredImage.userData.originalScale * 1.2,
                        hoveredImage.userData.originalScale * 1.2
                    );
                    document.body.style.cursor = 'pointer';
                } else {
                    document.body.style.cursor = 'default';
                }
            }
        }
        
        // Mouse click handler
        function onMouseClick(event) {
            const currentTime = new Date().getTime();
            const timeDiff = currentTime - lastClickTime;
            
            if (timeDiff < clickDelay) {
                toggleZoom();
            }
            
            lastClickTime = currentTime;
        }
        
        // Touch start handler
        function onTouchStart(event) {
            if (event.touches.length === 1) {
                const currentTime = new Date().getTime();
                const timeDiff = currentTime - lastClickTime;
                
                if (timeDiff < clickDelay) {
                    toggleZoom();
                }
                
                lastClickTime = currentTime;
            }
        }
        
        // Toggle zoom
        function toggleZoom() {
            if (zoomAnimation) {
                zoomAnimation.kill();
            }
            
            controls.autoRotate = false;
            
            if (!isZoomedIn) {
                zoomAnimation = gsap.timeline()
                    .call(() => {
                        showSpiralEffect();
                    })
                    .to(camera.position, {
                        duration: 3,
                        x: 15,
                        y: 10,
                        z: 25,
                        ease: "power2.inOut",
                        onUpdate: () => {
                            const progress = zoomAnimation.progress();
                            const spiralRadius = 15 * (1 - progress);
                            const spiralAngle = progress * Math.PI * 4;
                            camera.position.x = Math.cos(spiralAngle) * spiralRadius;
                            camera.position.z = Math.sin(spiralAngle) * spiralRadius;
                            camera.position.y = 10 * (1 - progress * 0.8);
                            camera.lookAt(0, 0, 0);
                            controls.update();
                        }
                    })
                    .to(camera, {
                        duration: 3,
                        fov: 45,
                        ease: "power2.inOut",
                        onUpdate: () => {
                            camera.updateProjectionMatrix();
                            camera.lookAt(0, 0, 0);
                            controls.update();
                        }
                    }, "-=3")
                    .to(camera.position, {
                        duration: 1,
                        x: 0,
                        y: 0,
                        z: 10,
                        ease: "power2.inOut",
                        onUpdate: () => {
                            camera.lookAt(0, 0, 0);
                            controls.update();
                        }
                    }, "-=1")
                    .to(heartGlow.material, {
                        duration: 1,
                        opacity: 0.6,
                        ease: "power1.inOut"
                    }, "-=2")
                    .to(this, {
                        duration: 1,
                        rotationSpeed: 1.0,
                        ease: "power1.inOut"
                    }, "-=2")
                    .to(particles.material, {
                        duration: 1,
                        opacity: 1.0,
                        ease: "power1.inOut"
                    }, "-=2")
                    .call(() => {
                        isZoomedIn = true;
                        document.getElementById('spiralEffect').classList.remove('active');
                        setTimeout(() => {
                            controls.autoRotate = true;
                        }, 1000);
                    });
            } else {
                zoomAnimation = gsap.timeline()
                    .to(camera, {
                        duration: 3,
                        fov: 60,
                        ease: "power2.inOut",
                        onUpdate: () => {
                            camera.updateProjectionMatrix();
                            const progress = zoomAnimation.progress();
                            const lookAtX = Math.sin(progress * Math.PI * 0.5) * 5;
                            const lookAtY = Math.cos(progress * Math.PI * 0.25) * 3;
                            camera.lookAt(lookAtX, lookAtY, 0);
                            controls.update();
                        }
                    })
                    .to(camera.position, {
                        duration: 3,
                        x: 15,
                        y: 5,
                        z: 20,
                        ease: "power2.inOut",
                        onUpdate: () => {
                            const progress = zoomAnimation.progress();
                            const lookAtX = Math.sin(progress * Math.PI * 0.5) * 5;
                            const lookAtY = Math.cos(progress * Math.PI * 0.25) * 3;
                            camera.lookAt(lookAtX, lookAtY, 0);
                            controls.update();
                        }
                    }, "-=3")
                    .to(camera, {
                        duration: 4,
                        fov: 65,
                        ease: "power2.inOut",
                        onUpdate: () => {
                            camera.updateProjectionMatrix();
                            const progress = zoomAnimation.progress();
                            const lookAtX = Math.sin(progress * Math.PI * 0.8) * 8;
                            const lookAtY = Math.cos(progress * 0.5) * 4;
                            camera.lookAt(lookAtX, lookAtY, 0);
                            controls.update();
                            if (progress > 0.3 && progress < 0.4) {
                                showPassThroughEffect();
                            }
                        }
                    })
                    .to(camera.position, {
                        duration: 4,
                        x: -20,
                        y: 8,
                        z: 20,
                        ease: "power2.inOut",
                        onUpdate: () => {
                            const progress = zoomAnimation.progress();
                            const lookAtX = Math.sin(progress * Math.PI * 0.8) * 8;
                            const lookAtY = Math.cos(progress * 0.5) * 4;
                            camera.lookAt(lookAtX, lookAtY, 0);
                            controls.update();
                            if (progress > 0.3 && progress < 0.4) {
                                showPassThroughEffect();
                            }
                        }
                    }, "-=4")
                    .to(camera, {
                        duration: 4,
                        fov: 70,
                        ease: "power2.inOut",
                        onUpdate: () => {
                            camera.updateProjectionMatrix();
                            const progress = zoomAnimation.progress();
                            const lookAtX = Math.sin(progress * Math.PI * 1.2) * 10;
                            const lookAtY = Math.cos(progress * 0.3) * 6;
                            camera.lookAt(lookAtX, lookAtY, 0);
                            controls.update();
                            if (progress > 0.6 && progress < 0.7) {
                                showPassThroughEffect();
                            }
                        }
                    })
                    .to(camera.position, {
                        duration: 4,
                        x: 15,
                        y: 15,
                        z: 20,
                        ease: "power2.inOut",
                        onUpdate: () => {
                            const progress = zoomAnimation.progress();
                            const lookAtX = Math.sin(progress * Math.PI * 1.2) * 10;
                            const lookAtY = Math.cos(progress * 0.3) * 6;
                            camera.lookAt(lookAtX, lookAtY, 0);
                            controls.update();
                            if (progress > 0.6 && progress < 0.7) {
                                showPassThroughEffect();
                            }
                        }
                    }, "-=4")
                    .to(camera, {
                        duration: 4,
                        fov: 75,
                        ease: "power2.inOut",
                        onUpdate: () => {
                            camera.updateProjectionMatrix();
                            const progress = zoomAnimation.progress();
                            const lookAtX = Math.sin(progress * Math.PI * 1.5) * 12;
                            const lookAtY = Math.cos(progress * 0.4) * 8;
                            camera.lookAt(lookAtX, lookAtY, 0);
                            controls.update();
                            if (progress > 0.85 && progress < 0.95) {
                                showPassThroughEffect();
                            }
                        }
                    })
                    .to(camera.position, {
                        duration: 4,
                        x: -25,
                        y: 25,
                        z: 20,
                        ease: "power2.inOut",
                        onUpdate: () => {
                            const progress = zoomAnimation.progress();
                            const lookAtX = Math.sin(progress * Math.PI * 1.5) * 12;
                            const lookAtY = Math.cos(progress * 0.4) * 8;
                            camera.lookAt(lookAtX, lookAtY, 0);
                            controls.update();
                            if (progress > 0.85 && progress < 0.95) {
                                showPassThroughEffect();
                            }
                        }
                    }, "-=4")
                    .to(camera.position, {
                        duration: 3,
                        x: 0,
                        y: 40,
                        z: 20,
                        ease: "power2.inOut",
                        onUpdate: () => {
                            camera.lookAt(0, 0, 0);
                            controls.update();
                        }
                    })
                    .to(heartGlow.material, {
                        duration: 15,
                        opacity: 0.3,
                        ease: "power1.inOut"
                    }, "-=18")
                    .to(this, {
                        duration: 3,
                        rotationSpeed: 0.5,
                        ease: "power1.inOut"
                    }, "-=15")
                    .to(particles.material, {
                        duration: 3,
                        opacity: 0.8,
                        ease: "power1.inOut"
                    }, "-=15")
                    .call(() => {
                        isZoomedIn = false;
                        setTimeout(() => {
                            controls.autoRotate = true;
                        }, 1000);
                    });
            }
        }
        
        // Show spiral effect
        function showSpiralEffect() {
            const effect = document.getElementById('spiralEffect');
            effect.classList.add('active');
            setTimeout(() => {
                effect.classList.remove('active');
            }, 2000);
        }
        
        // Show pass-through effect
        function showPassThroughEffect() {
            const effect = document.getElementById('passThroughEffect');
            effect.classList.add('active');
            setTimeout(() => {
                effect.classList.remove('active');
            }, 500);
        }
        
        // Toggle image ring visibility
        function toggleImageRing() {
            isImageRingVisible = !isImageRingVisible;
            const giftBtn = document.getElementById('giftBtn');
            
            if (isImageRingVisible) {
                imageRing.visible = true;
                imageRing.scale.set(0, 0, 0);
                gsap.to(imageRing.scale, { 
                    duration: 1, 
                    x: 1, 
                    y: 1, 
                    z: 1, 
                    ease: "elastic.out(1, 0.3)" 
                });
                giftBtn.classList.add('active');
            } else {
                gsap.to(imageRing.scale, { 
                    duration: 0.5, 
                    x: 0, 
                    y: 0, 
                    z: 0, 
                    ease: "back.in(1.7)",
                    onComplete: () => {
                        imageRing.visible = false;
                    }
                });
                giftBtn.classList.remove('active');
            }
        }
        
        // Toggle letter visibility
        function toggleLetter() {
            isLetterVisible = !isLetterVisible;
            const letterBtn = document.getElementById('letterBtn');
            const letter3dContainer = document.getElementById('letter3dContainer');
            
            if (isLetterVisible) {
                letter3dContainer.classList.add('visible');
                letterBtn.classList.add('active');
                gsap.to(heart.scale, {
                    duration: 0.5,
                    x: 2.8,
                    y: 2.8,
                    z: 2.8,
                    ease: "power2.inOut",
                    yoyo: true,
                    repeat: 1
                });
            } else {
                letter3dContainer.classList.remove('visible');
                letterBtn.classList.remove('active');
            }
        }
        
        // Toggle settings panel
        function toggleSettings() {
            const settingsPanel = document.getElementById('imagePathInput');
            settingsPanel.classList.toggle('active');
            if (settingsPanel.classList.contains('active')) {
                updatePathList();
            }
        }
        
        // Add image path
        function addImagePath() {
            const pathInput = document.getElementById('pathInput');
            const path = pathInput.value.trim();
            
            if (path) {
                tempImageUrls.push(path);
                pathInput.value = '';
                updatePathList();
            }
        }
        
        // Update path list display
        function updatePathList() {
            const pathList = document.getElementById('pathList');
            pathList.innerHTML = '';
            
            tempImageUrls.forEach((path, index) => {
                const pathItem = document.createElement('div');
                pathItem.className = 'path-item';
                
                const pathText = document.createElement('div');
                pathText.className = 'path-item-text';
                pathText.textContent = path;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-path-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', () => removePath(index));
                
                pathItem.appendChild(pathText);
                pathItem.appendChild(removeBtn);
                pathList.appendChild(pathItem);
            });
        }
        
        // Remove path from list
        function removePath(index) {
            tempImageUrls.splice(index, 1);
            updatePathList();
        }
        
        // Clear all paths
        function clearAllPaths() {
            tempImageUrls = [];
            updatePathList();
        }
        
        // Apply image paths
        function applyImagePaths() {
            uniqueImageUrls = [...tempImageUrls];
            location.reload();
        }
        
        // Hide message modal
        function hideMessage() {
            document.getElementById('messageModal').classList.remove('active');
            document.getElementById('letterBtn').classList.remove('active');
            isTextVisible = false;
            document.getElementById('text3dContainer').classList.remove('visible');
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            controls.update();
            
            if (heart) {
                heart.rotation.y += 0.005;
            }
            
            if (imageRing && isImageRingVisible) {
                imageRing.rotation.y += 0.002 * rotationSpeed;
            }
            
            if (particles) {
                particles.rotation.x += 0.0005;
                particles.rotation.y += 0.001;
                
                const positions = particles.geometry.attributes.position.array;
                const time = Date.now() * 0.0005;
                
                for (let i = 0; i < positions.length; i += 3) {
                    positions[i + 1] = positions[i + 1] + Math.sin(time + i) * 0.001;
                }
                
                particles.geometry.attributes.position.needsUpdate = true;
            }
            
            renderer.render(scene, camera);
        }
        
        window.addEventListener('load', init);
    </script>
</body>
</html>